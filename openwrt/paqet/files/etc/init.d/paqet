#!/bin/sh /etc/rc.common
USE_PROCD=1

START=95
STOP=10

PROG="/usr/bin/paqet"
CFG_DIR="/etc/paqet"
PAQET_CFG="${CFG_DIR}/paqet.yaml"
SB_CFG="${CFG_DIR}/sing-box.json"

GEN="/usr/share/paqet/gen.sh"
RULES="/usr/share/paqet/rules.sh"

start_service() {
	. /lib/functions.sh
	config_load paqet

	local enabled
	config_get_bool enabled main enabled 0
	[ "$enabled" -eq 1 ] || return 0

	local singbox_bin
	config_get singbox_bin main singbox_bin "/usr/bin/sing-box"

	[ -x "$PROG" ] || { logger -t paqet "ERROR: paqet binary not found at $PROG"; return 1; }
	[ -x "$singbox_bin" ] || { logger -t paqet "ERROR: sing-box binary not found at $singbox_bin"; return 1; }

	mkdir -p "$CFG_DIR"

	# Generate /etc/paqet/paqet.yaml and /etc/paqet/sing-box.json
	"$GEN" || return 1

	# Start paqet (SOCKS)
	procd_open_instance paqet
	procd_set_param command "$PROG" run -c "$PAQET_CFG"
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param respawn 3600 5 0
	procd_close_instance

	# Start sing-box (TUN inbound -> SOCKS outbound)
	procd_open_instance singbox
	procd_set_param command "$singbox_bin" run -c "$SB_CFG"
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param respawn 3600 5 0
	procd_close_instance

	# Apply routing + nft marking (script waits for TUN to exist)
	"$RULES" start || true
}

stop_service() {
	[ -x "$RULES" ] && "$RULES" stop || true
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "paqet"
	procd_add_reload_trigger "network"
	procd_add_reload_trigger "firewall"
}
