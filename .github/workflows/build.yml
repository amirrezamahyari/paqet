name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: golang:1.25
    strategy:
      matrix:
        include:
          - goarch: amd64
            filename: amd64
          - goarch: arm64
            filename: arm64
          - goarch: arm
            filename: arm32

    steps:
      - name: Setup Build Environment
        run: |
          set -e
          apt-get update
          if [ "${{ matrix.goarch }}" = "arm64" ]; then
            dpkg --add-architecture arm64
            apt-get update
            apt-get install -y --no-install-recommends gcc-aarch64-linux-gnu libc6-dev-arm64-cross libpcap-dev:arm64
          elif [ "${{ matrix.goarch }}" = "arm" ]; then
            dpkg --add-architecture armhf
            apt-get update
            apt-get install -y --no-install-recommends gcc-arm-linux-gnueabihf libc6-dev-armhf-cross libpcap-dev:armhf
          else
            apt-get install -y --no-install-recommends build-essential libpcap-dev
          fi

      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Mark repo as safe
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Get tag or commit
        id: ref_id
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_ID="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: $REF_ID"
          else
            REF_ID=$(git rev-parse --short HEAD)
            echo "No tag detected. Using commit hash: $REF_ID"
          fi
          echo "ref=$REF_ID" >> $GITHUB_OUTPUT

      - name: Build
        run: |
          mkdir -p dist
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=${{ matrix.goarch }}
          export VERSION=${{ steps.ref_id.outputs.ref }}
          export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
          export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          # Set the C compiler for cross-compilation
          if [ "$GOARCH" = "arm64" ]; then
            export CC=aarch64-linux-gnu-gcc
          elif [ "$GOARCH" = "arm" ]; then
            export CC=arm-linux-gnueabihf-gcc
            export GOARM=7
          fi

          go build -v -a -trimpath \
            -gcflags "all=-l=4" \
            -ldflags "-s -w -buildid= \
            -X 'paqet/cmd/version.Version=${VERSION}' \
            -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
            -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
            -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
            -o paqet_linux_${{ matrix.filename }} ./cmd/main.go

          chmod +x paqet_linux_${{ matrix.filename }}
          tar -czvf dist/paqet-linux-${{ matrix.filename }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
            paqet_linux_${{ matrix.filename }} \
            README.md \
            example/client.yaml.example \
            example/server.yaml.example

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paqet-linux-${{ matrix.filename }}
          path: dist/paqet-linux-${{ matrix.filename }}-${{ steps.ref_id.outputs.ref }}.tar.gz
          retention-days: 1

  # âœ… NEW: OpenWrt build for Xiaomi Redmi Router AX6S (mediatek/mt7622, ARMv8/aarch64)
  build-openwrt-mt7622:
    name: Build OpenWrt (mt7622 / ARMv8)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup QEMU (run arm64 containers)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Get tag or commit
        id: ref_id
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_ID="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: $REF_ID"
          else
            REF_ID=$(git rev-parse --short HEAD)
            echo "No tag detected. Using commit hash: $REF_ID"
          fi
          echo "ref=$REF_ID" >> $GITHUB_OUTPUT

      - name: Build (musl) + package (.tar.gz + .ipk)
        shell: bash
        run: |
          mkdir -p dist

          # Build inside an ARM64 Alpine container so the output is musl-linked (OpenWrt-friendly)
          docker run --rm --platform linux/arm64 \
            -v "${{ github.workspace }}:/src" \
            -w /src \
            -e VERSION="${{ steps.ref_id.outputs.ref }}" \
            -e GITHUB_REPOSITORY="${{ github.repository }}" \
            golang:1.25-alpine sh -euc '
              apk add --no-cache git build-base libpcap-dev tar gzip binutils coreutils

              git config --global --add safe.directory /src
              mkdir -p dist

              export CGO_ENABLED=1
              export GOOS=linux
              export GOARCH=arm64

              export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
              export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
              # No spaces -> easier/safer in -ldflags
              export BUILD_TIME=$(date -u "+%Y-%m-%dT%H:%M:%SZ")

              go build -v -a -trimpath \
                -gcflags "all=-l=4" \
                -ldflags "-s -w -buildid= \
                  -X paqet/cmd/version.Version=${VERSION} \
                  -X paqet/cmd/version.GitCommit=${GIT_COMMIT} \
                  -X paqet/cmd/version.GitTag=${GIT_TAG} \
                  -X paqet/cmd/version.BuildTime=${BUILD_TIME}" \
                -o paqet_openwrt_mt7622_arm64 ./cmd/main.go

              chmod +x paqet_openwrt_mt7622_arm64

              # Tarball for manual install (scp + run)
              tar -czvf dist/paqet-openwrt-mt7622-arm64-${VERSION}.tar.gz \
                paqet_openwrt_mt7622_arm64 \
                README.md \
                example/client.yaml.example \
                example/server.yaml.example

              # Build a simple .ipk for opkg install
              PKG_NAME="paqet"
              PKG_VER="${VERSION#v}"
              PKG_REL="1"
              IPK_ARCH="aarch64_cortex-a53"

              WORKDIR="$(mktemp -d)"
              mkdir -p "${WORKDIR}/data/usr/bin" "${WORKDIR}/control"
              install -m 0755 paqet_openwrt_mt7622_arm64 "${WORKDIR}/data/usr/bin/paqet"

              SIZE_KB="$(du -ks "${WORKDIR}/data" | awk "{print \$1}")"
              cat > "${WORKDIR}/control/control" <<EOF
              Package: ${PKG_NAME}
              Version: ${PKG_VER}-${PKG_REL}
              Architecture: ${IPK_ARCH}
              Maintainer: ${GITHUB_REPOSITORY}
              Section: net
              Priority: optional
              Depends: libpcap, libgcc
              Installed-Size: ${SIZE_KB}
              Description: paqet for OpenWrt (mediatek/mt7622, ARMv8 / aarch64_cortex-a53_musl)
              EOF

                            tar -C "${WORKDIR}/control" -czf "${WORKDIR}/control.tar.gz" .
                            tar -C "${WORKDIR}/data" -czf "${WORKDIR}/data.tar.gz" .
                            printf "2.0\n" > "${WORKDIR}/debian-binary"

                            ar -rc dist/${PKG_NAME}_${PKG_VER}-${PKG_REL}_${IPK_ARCH}.ipk \
                              "${WORKDIR}/debian-binary" \
                              "${WORKDIR}/control.tar.gz" \
                              "${WORKDIR}/data.tar.gz"

                            chmod -R a+rX dist
                          '

      - name: Upload Artifact (OpenWrt)
        uses: actions/upload-artifact@v4
        with:
          name: paqet-openwrt-mt7622-arm64
          path: |
            dist/paqet-openwrt-mt7622-arm64-*.tar.gz
            dist/paqet_*.ipk
          retention-days: 1

  build-openwrt-ax6s:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Build OpenWrt IPKs (23.05.2 mediatek/mt7622)
        shell: bash
        run: |
          set -euxo pipefail

          OWRT_VER="23.05.2"
          TARGET_PATH="mediatek/mt7622"
          BASE_URL="https://downloads.openwrt.org/releases/${OWRT_VER}/targets/${TARGET_PATH}"

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison gawk gettext \
            libncurses-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev file wget curl

          SDK_FILE="$(curl -fsSL "${BASE_URL}/" | grep -oE 'openwrt-sdk-[^" ]+\.Linux-x86_64\.tar\.xz' | head -n1)"
          test -n "$SDK_FILE"
          curl -fL "${BASE_URL}/${SDK_FILE}" -o sdk.tar.xz

          SDK_DIR="$(tar -tf sdk.tar.xz | head -n1 | cut -d/ -f1)"
          tar -xf sdk.tar.xz
          cd "$SDK_DIR"

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # copy packages into SDK
          rm -rf package/paqet package/luci-app-paqet
          cp -r "$GITHUB_WORKSPACE/openwrt/paqet" package/paqet
          cp -r "$GITHUB_WORKSPACE/openwrt/luci-app-paqet" package/luci-app-paqet

          make defconfig
          make package/paqet/compile V=s
          make package/luci-app-paqet/compile V=s

          mkdir -p "$GITHUB_WORKSPACE/dist"
          find bin/packages -name 'paqet_*.ipk' -o -name 'luci-app-paqet_*.ipk' -exec cp -v {} "$GITHUB_WORKSPACE/dist/" \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ax6s-ipks
          path: dist/*.ipk
          retention-days: 1

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        goarch: [amd64]
    steps:
      - name: Setup Build Environment
        run: |
          choco install npcap -y
          choco install mingw -y

      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Get tag or commit
        id: ref_id
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_ID="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: $REF_ID"
          else
            REF_ID=$(git rev-parse --short HEAD)
            echo "No tag detected. Using commit hash: $REF_ID"
          fi
          echo "ref=$REF_ID" >> $GITHUB_OUTPUT

      - name: Build
        shell: bash
        run: |
          mkdir -p dist
          export CGO_ENABLED=1
          export GOOS=windows
          export GOARCH=${{ matrix.goarch }}
          export VERSION=${{ steps.ref_id.outputs.ref }}
          export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
          export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          go build -v -a -trimpath \
            -gcflags "all=-l=4" \
            -ldflags "-s -w -buildid= \
            -X 'paqet/cmd/version.Version=${VERSION}' \
            -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
            -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
            -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
            -o paqet_windows_${{ matrix.goarch }}.exe ./cmd/main.go

          7z a -tzip dist/paqet-windows-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.zip \
            paqet_windows_${{ matrix.goarch }}.exe \
            README.md \
            example/client.yaml.example \
            example/server.yaml.example

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paqet-windows-${{ matrix.goarch }}
          path: dist/paqet-windows-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.zip
          retention-days: 1

  build-darwin:
    runs-on: macos-latest
    strategy:
      matrix:
        goarch: [amd64, arm64]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Get tag or commit
        id: ref_id
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            REF_ID="${GITHUB_REF#refs/tags/}"
            echo "Triggered by tag: $REF_ID"
          else
            REF_ID=$(git rev-parse --short HEAD)
            echo "No tag detected. Using commit hash: $REF_ID"
          fi
          echo "ref=$REF_ID" >> $GITHUB_OUTPUT

      - name: Build
        run: |
          mkdir -p dist
          export CGO_ENABLED=1
          export GOOS=darwin
          export GOARCH=${{ matrix.goarch }}
          export VERSION=${{ steps.ref_id.outputs.ref }}
          export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
          export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          go build -v -a -trimpath \
            -gcflags "all=-l=4" \
            -ldflags "-s -w -buildid= \
            -X 'paqet/cmd/version.Version=${VERSION}' \
            -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
            -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
            -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
            -o paqet_darwin_${{ matrix.goarch }} ./cmd/main.go

          chmod +x paqet_darwin_${{ matrix.goarch }}
          tar -czvf dist/paqet-darwin-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
            paqet_darwin_${{ matrix.goarch }} \
            README.md \
            example/client.yaml.example \
            example/server.yaml.example

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paqet-darwin-${{ matrix.goarch }}
          path: dist/paqet-darwin-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz
          retention-days: 1

  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-darwin, build-windows, build-openwrt-mt7622, build-openwrt-ax6s]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist
          pattern: paqet-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
